{% extends 'base.html' %}
{% block content %}
<style>
  .settings-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .settings-header {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    margin-bottom: 30px;
  }
  
  .settings-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 14px;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .form-help {
    font-size: 13px;
    color: #7f8c8d;
    margin-top: 5px;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .slider {
    background-color: #27ae60;
  }
  
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 40px;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: transform 0.3s;
  }
  
  .submit-btn:hover {
    transform: scale(1.02);
  }
  
  .test-btn {
    background: #3498db;
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
  }
  
  .test-btn:hover {
    background: #2980b9;
  }
  
  .info-box {
    background: #e7f3ff;
    border-left: 4px solid #2196F3;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 4px;
  }
  
  .warning-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 4px;
  }
  
  .success-box {
    background: #d4edda;
    border-left: 4px solid #28a745;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 4px;
  }
</style>

<div class="settings-container">
  <div class="settings-header">
    <h1>üìß Email Notification Settings</h1>
    <p>Configure email notifications for asset assignments and checkouts</p>
  </div>
  
  <div class="settings-card">
    <h2 style="margin-top: 0; color: #2c3e50;">Email Configuration</h2>
    
    <div class="info-box">
      <strong>‚ÑπÔ∏è Information:</strong> Email notifications will be sent automatically when assets are assigned or checked out to users who have email addresses in their profile.
    </div>
    
    <form method="POST" action="/settings/email">
      <div class="form-group">
        <label for="email_enabled">
          Enable Email Notifications
        </label>
        <label class="toggle-switch">
          <input type="checkbox" id="email_enabled" name="email_enabled" {% if email_config.get('enabled') %}checked{% endif %}>
          <span class="slider"></span>
        </label>
        <div class="form-help">Turn on to send automatic email notifications</div>
      </div>
      
      <div class="form-group">
        <label for="sender_email">Sender Email Address *</label>
        <input type="email" id="sender_email" name="sender_email" 
               value="{{ email_config.get('sender_email', '') }}" 
               placeholder="notifications@yourdomain.com" required>
        <div class="form-help">The email address that will send notifications (e.g., Gmail, Office365)</div>
      </div>
      
      <div class="form-group">
        <label for="sender_password">Email Password / App Password *</label>
        <input type="password" id="sender_password" name="sender_password" 
               placeholder="Enter email password or app-specific password" required>
        <div class="form-help">
          <strong>For Gmail:</strong> Use App Password (Settings ‚Üí Security ‚Üí 2-Step Verification ‚Üí App passwords)<br>
          <strong>For Office365:</strong> Use account password or app password
        </div>
      </div>
      
      <div class="form-group">
        <label for="smtp_server">SMTP Server *</label>
        <input type="text" id="smtp_server" name="smtp_server" 
               value="{{ email_config.get('smtp_server', 'smtp.gmail.com') }}" 
               placeholder="smtp.gmail.com" required>
        <div class="form-help">
          Common servers: smtp.gmail.com (Gmail), smtp.office365.com (Office365), smtp.mail.yahoo.com (Yahoo)
        </div>
      </div>
      
      <div class="form-group">
        <label for="smtp_port">SMTP Port *</label>
        <select id="smtp_port" name="smtp_port" required>
          <option value="587" {% if email_config.get('smtp_port', 587) == 587 %}selected{% endif %}>587 (TLS - Recommended)</option>
          <option value="465" {% if email_config.get('smtp_port') == 465 %}selected{% endif %}>465 (SSL)</option>
          <option value="25" {% if email_config.get('smtp_port') == 25 %}selected{% endif %}>25 (Plain - Not recommended)</option>
        </select>
        <div class="form-help">Port 587 with TLS is recommended for most email providers</div>
      </div>
      
      <div class="warning-box">
        <strong>‚ö†Ô∏è Security Note:</strong> Email passwords are stored securely as environment variables. For production use, consider using app-specific passwords rather than your main account password.
      </div>
      
      <button type="submit" class="submit-btn">
        üíæ Save Email Settings
      </button>
      
      <button type="button" class="test-btn" onclick="testEmail()">
        üì® Send Test Email
      </button>
    </form>
  </div>
  
  <div class="settings-card">
    <h2 style="margin-top: 0; color: #2c3e50;">Email Templates Preview</h2>
    
    <div class="success-box">
      <strong>‚úÖ What Users Receive:</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li><strong>Asset Assignment:</strong> Detailed email with asset information, serial number, location, and reminders</li>
        <li><strong>Checkout Notification:</strong> Confirmation of checked out items with quantity and return instructions</li>
        <li>Both emails include department, location, and any additional notes</li>
        <li>Professional formatting with clear sections and important reminders</li>
      </ul>
    </div>
    
    <div class="info-box">
      <strong>üìã Requirements:</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>Users must have valid email addresses in their profiles</li>
        <li>Email configuration must be enabled and properly set up</li>
        <li>SMTP credentials must be valid and have permission to send emails</li>
      </ul>
    </div>
  </div>
</div>

<script>
  function testEmail() {
    if (!confirm('Send a test email to verify your configuration?')) {
      return;
    }
    
    const formData = new FormData(document.querySelector('form'));
    
    fetch('/settings/email/test', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ Test email sent successfully! Check your inbox.');
      } else {
        alert('‚ùå Failed to send test email: ' + data.error);
      }
    })
    .catch(error => {
      alert('‚ùå Error sending test email: ' + error.message);
    });
  }
</script>

{% endblock %}
