{% extends 'base.html' %}
{% block content %}
  <div class="fade-in">
  <div class="dashboard-header">
    <div>
      <h2>Overview</h2>
      <p style="color:#7f8c8d;">Welcome to your Asset Management Dashboard</p>
    </div>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <!-- Bootstrap Dropdown for Download -->
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle d-flex align-items-center gap-2" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;box-shadow:0 2px 8px rgba(102,126,234,0.3);">
          <i class="bi bi-download"></i>
          <span>Download Dashboard</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="downloadDropdown" style="border-radius:8px;min-width:220px;">
          <li>
            <a class="dropdown-item d-flex align-items-center gap-3 py-2" href="/dashboard/export/pdf">
              <i class="bi bi-file-pdf text-danger fs-5"></i>
              <span>Download as PDF</span>
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item d-flex align-items-center gap-3 py-2" href="/dashboard/export/excel">
              <i class="bi bi-file-excel text-success fs-5"></i>
              <span>Download as Excel</span>
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item d-flex align-items-center gap-3 py-2" href="/dashboard/export/csv">
              <i class="bi bi-file-earmark-spreadsheet text-info fs-5"></i>
              <span>Download as CSV</span>
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Manage Dashboard Button with Bootstrap -->
      <a href="/manage-dashboard" class="btn btn-info text-white d-flex align-items-center gap-2 shadow-sm" style="background:#3498db;">
        <i class="bi bi-gear-fill"></i>
        <span>Manage Dashboard</span>
      </a>
    </div>
  </div>
  
  <div class="dashboard">
    {% if 'total_assets' in dashboard_widgets %}
    <a href="/assets" class="metric-card metric-link" title="View all assets">
      <div>
        <div class="metric-label">Total Assets</div>
        <div class="metric-value">{{ total_items }}</div>
      </div>
      <div class="icon">üì¶</div>
    </a>
    {% endif %}
    
    {% if 'inhouse_assets' in dashboard_widgets %}
    <a href="/assets" class="metric-card metric-link" title="View in-house assets">
      <div>
        <div class="metric-label">In-House Assets</div>
        <div class="metric-value">{{ inhouse_assets }}</div>
      </div>
      <div class="icon">üè¢</div>
    </a>
    {% endif %}
    
    {% if 'total_value' in dashboard_widgets %}
    <a href="/assets" class="metric-card metric-link" title="View asset value">
      <div>
        <div class="metric-label">Total Value</div>
        <div class="metric-value">VT{{ '{:,.0f}'.format(total_value) }}</div>
      </div>
      <div class="icon">üí∞</div>
    </a>
    {% endif %}
    
    {% if 'categories' in dashboard_widgets %}
    <a href="/assets" class="metric-card metric-link" title="View categories">
      <div>
        <div class="metric-label">Categories</div>
        <div class="metric-value">{{ unique_categories }}</div>
      </div>
      <div class="icon">üè∑Ô∏è</div>
    </a>
    {% endif %}
  </div>

  <!-- Optional Additional Widgets -->
  <div class="dashboard">
    
    {% if 'suppliers' in dashboard_widgets %}
    <a href="/suppliers" class="metric-card metric-link" title="View suppliers">
      <div>
        <div class="metric-label">Suppliers</div>
        <div class="metric-value">{{ total_suppliers }}</div>
      </div>
      <div class="icon">üè¢</div>
    </a>
    {% endif %}
    
    {% if 'checked_out' in dashboard_widgets %}
    <a href="/lists-checkouts" class="metric-card metric-link" title="View checked out items">
      <div>
        <div class="metric-label">Checked Out</div>
        <div class="metric-value">{{ checked_out }}</div>
      </div>
      <div class="icon">üì§</div>
    </a>
    {% endif %}
    
    {% if 'pending_maintenance' in dashboard_widgets %}
    <a href="/lists-maintenances" class="metric-card metric-link" title="View pending maintenance">
      <div>
        <div class="metric-label">Pending Maintenance</div>
        <div class="metric-value">{{ pending_maintenance }}</div>
      </div>
      <div class="icon">üîß</div>
    </a>
    {% endif %}
  </div>

  <!-- Recent Activity Widget -->
  {% if 'recent_activity' in dashboard_widgets %}
  <div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin:30px 0;">
    <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>üìã</i> Recent Activity</h3>
    <table>
      <tr><th>Name</th><th>Qty</th><th>Price</th><th>Category</th><th>Supplier</th><th>Dept/Cost Center</th><th>Location</th></tr>
      {% for name, d in recent_activity %}
        <tr>
          <td>{{ name }}</td>
          <td>{{ d.quantity }}</td>
          <td>VT{{ '%.2f'|format(d.price) }}</td>
          <td>{{ d.category }}</td>
          <td>{{ d.supplier }}</td>
          <td>{{ d.department or '-' }}</td>
          <td>{{ d.location or '-' }}</td>
        </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}

  <!-- Charts Section -->
  {% if dashboard_charts %}
  <div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin:30px 0;">
    <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>üìä</i> Dashboard Charts</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;">
      
      {% if 'bar_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üìä Assets by Category</h4>
        <p style="color:#7f8c8d;font-size:14px;">Bar chart showing asset distribution across categories</p>
        <canvas id="barChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'line_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üìà Asset Value Over Time</h4>
        <p style="color:#7f8c8d;font-size:14px;">Line chart tracking value trends</p>
        <canvas id="lineChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'pie_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">ü•ß Category Distribution</h4>
        <p style="color:#7f8c8d;font-size:14px;">Pie chart of categories</p>
        <canvas id="pieChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'donut_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üç© Department/Cost Center Breakdown</h4>
        <p style="color:#7f8c8d;font-size:14px;">Donut chart by department/cost center</p>
        <canvas id="donutChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'area_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üìâ Stock Levels Trend</h4>
        <p style="color:#7f8c8d;font-size:14px;">Area chart showing stock trends</p>
        <canvas id="areaChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'scatter_chart' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">‚ö´ Price vs Quantity</h4>
        <p style="color:#7f8c8d;font-size:14px;">Scatter plot analysis</p>
        <canvas id="scatterChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
      {% if 'heatmap' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üî• Usage by Department/Cost Center</h4>
        <p style="color:#7f8c8d;font-size:14px;">Heat map of department/cost center usage</p>
        <div id="heatMap" style="height:300px;"></div>
      </div>
      {% endif %}
      
      {% if 'gauge' in dashboard_charts %}
      <div style="border:1px solid #e0e0e0;border-radius:8px;padding:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;">üéØ Stock Utilization</h4>
        <p style="color:#7f8c8d;font-size:14px;">Gauge showing utilization rate</p>
        <canvas id="gaugeChart" style="max-height:300px;"></canvas>
      </div>
      {% endif %}
      
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Sample chart data - replace with actual data from backend
    {% if 'bar_chart' in dashboard_charts %}
    const barCtx = document.getElementById('barChart');
    if (barCtx) {
      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: ['Electronics', 'Furniture', 'Supplies', 'Equipment', 'Vehicles'],
          datasets: [{
            label: 'Asset Count',
            data: [12, 19, 3, 5, 2],
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    {% endif %}
    
    {% if 'line_chart' in dashboard_charts %}
    const lineCtx = document.getElementById('lineChart');
    if (lineCtx) {
      new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Total Value',
            data: [12000, 19000, 15000, 25000, 22000, 30000],
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.1
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    {% endif %}
    
    {% if 'pie_chart' in dashboard_charts %}
    const pieCtx = document.getElementById('pieChart');
    if (pieCtx) {
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: ['Electronics', 'Furniture', 'Supplies', 'Equipment'],
          datasets: [{
            data: [30, 25, 20, 25],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    {% endif %}
    
    {% if 'donut_chart' in dashboard_charts %}
    const donutCtx = document.getElementById('donutChart');
    if (donutCtx) {
      new Chart(donutCtx, {
        type: 'doughnut',
        data: {
          labels: ['IT', 'HR', 'Finance', 'Operations'],
          datasets: [{
            data: [35, 20, 25, 20],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    {% endif %}
    
    {% if 'area_chart' in dashboard_charts %}
    const areaCtx = document.getElementById('areaChart');
    if (areaCtx) {
      new Chart(areaCtx, {
        type: 'line',
        data: {
          labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          datasets: [{
            label: 'Stock Level',
            data: [65, 59, 80, 81],
            fill: true,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    {% endif %}
    
    {% if 'scatter_chart' in dashboard_charts %}
    const scatterCtx = document.getElementById('scatterChart');
    if (scatterCtx) {
      new Chart(scatterCtx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Assets',
            data: [{x: 10, y: 20}, {x: 15, y: 30}, {x: 20, y: 25}, {x: 25, y: 40}],
            backgroundColor: 'rgba(255, 99, 132, 1)'
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Quantity' } },
            y: { title: { display: true, text: 'Price' } }
          }
        }
      });
    }
    {% endif %}
    
    {% if 'gauge' in dashboard_charts %}
    const gaugeCtx = document.getElementById('gaugeChart');
    if (gaugeCtx) {
      new Chart(gaugeCtx, {
        type: 'doughnut',
        data: {
          labels: ['Used', 'Available'],
          datasets: [{
            data: [75, 25],
            backgroundColor: ['#36A2EB', '#E7E7E7'],
            circumference: 180,
            rotation: 270
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    }
    {% endif %}
  </script>
  {% endif %}

  <table>
    <tr><th>Name</th><th>Qty</th><th>Price</th><th>Category</th><th>Supplier</th><th>Dept/Cost Center</th><th>Location</th><th>Description</th></tr>
    {% for name, d in inventory_items %}
      <tr>
        <td>{{ name }}</td>
        <td>{{ d.quantity }}</td>
        <td>VT{{ '%.2f'|format(d.price) }}</td>
        <td>{{ d.category }}</td>
        <td>{{ d.supplier }}</td>
        <td>{{ d.department or '-' }}</td>
        <td>{{ d.location or '-' }}</td>
        <td>{{ d.description or '' }}</td>
      </tr>
    {% endfor %}
  </table>
  </div>
{% endblock %}
