{% extends 'base.html' %}
{% block content %}
  <div class="fade-in">
    <h2>Asset List</h2>
    
    <div style="margin-bottom:15px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <button id="selectAllBtn" onclick="toggleSelectAll()" style="background-color:#3498db;color:white;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;">Select All</button>
      <button onclick="deleteSelected()" style="background-color:#e74c3c;color:white;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;">Delete Selected</button>
      <span id="selectedCount" style="color:#7f8c8d;font-weight:bold;">0 selected</span>
    </div>

    <form id="bulkActionForm" method="post">
      <div class="table-responsive">
        <table>
      <tr>
        <th style="width:40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
        <th>Name</th>
        <th>Quantity</th>
        <th>Purchase Price</th>
        <th>Current Value</th>
        <th>Category</th>
        <th>Model</th>
        <th>Brand</th>
        <th>Serial Number</th>
        <th>Purchase Date</th>
        <th>Depreciation</th>
        <th>Location</th>
        <th>Actions</th>
      </tr>
      {% for name, d in assets %}
        <tr>
          <td><input type="checkbox" class="asset-checkbox" name="selected_assets" value="{{ name }}" onchange="updateSelectedCount()"></td>
          <td><strong>{{ name }}</strong></td>
          <td>{{ d.quantity }}</td>
          <td>VT{{ '%.2f'|format(d.price) }}</td>
          <td>
            <span style="color:#27ae60;font-weight:600;">VT{{ '%.2f'|format(d.current_value) }}</span>
            {% if d.purchase_date and d.depreciation_method != 'none' %}
              {% set depreciation_percent = ((d.price - d.current_value) / d.price * 100) if d.price > 0 else 0 %}
              <br><small style="color:#7f8c8d;">({{ '%.1f'|format(depreciation_percent) }}% depreciated)</small>
            {% endif %}
          </td>
          <td>{{ d.category }}</td>
          <td>{{ d.model or '-' }}</td>
          <td>{{ d.brand or '-' }}</td>
          <td>{{ d.serial_number or '-' }}</td>
          <td>{{ d.purchase_date or '-' }}</td>
          <td>
            {% if d.depreciation_method == 'straight_line' %}
              <span style="color:#3498db;">Straight Line</span>
            {% elif d.depreciation_method == 'declining_balance' %}
              <span style="color:#9b59b6;">Declining Balance</span>
            {% else %}
              <span style="color:#95a5a6;">None</span>
            {% endif %}
            {% if d.useful_life_years %}
              <br><small>{{ d.useful_life_years }}yr life</small>
            {% endif %}
          </td>
          <td>{{ d.location or '-' }}</td>
          <td>
            <a href="{{ url_for('view_asset', asset_name=name) }}" style="background-color:#9b59b6;color:white;padding:5px 10px;border:none;border-radius:4px;text-decoration:none;display:inline-block;margin-right:5px;">View</a>
            <a href="{{ url_for('assign_asset', asset_name=name) }}" style="background-color:#f39c12;color:white;padding:5px 10px;border:none;border-radius:4px;text-decoration:none;display:inline-block;margin-right:5px;">Assign</a>
            <a href="{{ url_for('edit_asset', asset_name=name) }}" style="background-color:#3498db;color:white;padding:5px 10px;border:none;border-radius:4px;text-decoration:none;display:inline-block;margin-right:5px;">Edit</a>
            <form method="post" action="{{ url_for('delete_asset', asset_name=name) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete {{ name }}?');">
              <button type="submit" style="background-color:#e74c3c;color:white;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </table>
      </div>
  </form>
  </div>

  <script>
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.asset-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.asset-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count + ' selected';
      
      // Update "Select All" checkbox state
      const allCheckboxes = document.querySelectorAll('.asset-checkbox');
      const selectAllCheckbox = document.getElementById('selectAll');
      selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
    }

    function deleteSelected() {
      const checkboxes = document.querySelectorAll('.asset-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select at least one asset to delete');
        return;
      }
      
      const assetNames = Array.from(checkboxes).map(cb => cb.value);
      const confirmMsg = `Are you sure you want to delete ${checkboxes.length} asset(s)?\n\n${assetNames.join(', ')}`;
      
      if (confirm(confirmMsg)) {
        const form = document.getElementById('bulkActionForm');
        form.action = '{{ url_for("delete_selected_assets") }}';
        form.submit();
      }
    }
  </script>
{% endblock %}