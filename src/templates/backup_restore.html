{% extends 'base.html' %}

{% block content %}

<div class="dashboard-header">
  <div>
    <h2>ğŸ’¿ Backup & Restore Database</h2>
    <p>Create backups and restore your database safely.</p>
  </div>
</div>

<!-- Backup Section -->
<div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin-bottom:30px;">
  <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>ğŸ’¾</i> Create Database Backup</h3>
  <p style="color:#7f8c8d;margin-bottom:20px;">Download a complete backup of your database in your preferred format.</p>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px;">
    <!-- SQL Backup -->
    <div style="border:2px solid #3498db;border-radius:8px;padding:20px;text-align:center;transition:all 0.3s;">
      <div style="font-size:48px;margin-bottom:10px;">ğŸ—„ï¸</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">SQL Database</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">Complete MySQL database dump with structure and data</p>
      <form method="post" action="/backup/sql" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" style="background:#3498db;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;">
          ğŸ“¥ Download SQL
        </button>
      </form>
    </div>

    <!-- Excel Backup -->
    <div style="border:2px solid #27ae60;border-radius:8px;padding:20px;text-align:center;transition:all 0.3s;">
      <div style="font-size:48px;margin-bottom:10px;">ğŸ“Š</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">Excel Format</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">All tables exported to Excel spreadsheet with multiple sheets</p>
      <form method="post" action="/export/all" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="format" value="excel">
        <button type="submit" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;">
          ğŸ“¥ Download Excel
        </button>
      </form>
    </div>

    <!-- CSV Backup -->
    <div style="border:2px solid #e67e22;border-radius:8px;padding:20px;text-align:center;transition:all 0.3s;">
      <div style="font-size:48px;margin-bottom:10px;">ğŸ“„</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">CSV Format</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">ZIP archive with CSV files for each table</p>
      <form method="post" action="/export/all" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="format" value="csv">
        <button type="submit" style="background:#e67e22;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;">
          ğŸ“¥ Download CSV
        </button>
      </form>
    </div>
  </div>

  <div style="background:#e8f4f8;border-left:4px solid #3498db;padding:15px;border-radius:5px;margin-top:20px;">
    <strong style="color:#2c3e50;">ğŸ’¡ Backup Tips:</strong>
    <ul style="margin:10px 0 0 20px;color:#555;line-height:1.8;">
      <li>Create regular backups before major changes</li>
      <li>Store backups in a secure location</li>
      <li>SQL format is best for complete restoration</li>
      <li>Excel/CSV formats are useful for data analysis</li>
    </ul>
  </div>
</div>

<!-- Restore Section -->
<div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin-bottom:30px;">
  <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>â®ï¸</i> Restore Database</h3>
  <p style="color:#7f8c8d;margin-bottom:20px;">Restore your database from a previous backup file.</p>

  <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;border-radius:5px;margin-bottom:20px;">
    <strong style="color:#856404;">âš ï¸ Warning:</strong>
    <p style="color:#856404;margin:5px 0 0 0;">Restoring will replace all current data. Make sure to create a backup first!</p>
  </div>

  <form method="post" action="/restore/sql" enctype="multipart/form-data" onsubmit="return confirm('âš ï¸ This will replace ALL current data. Are you sure you want to restore from this backup?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <div style="border:2px dashed #ccc;border-radius:8px;padding:30px;text-align:center;background:#f8f9fa;">
      <div style="font-size:48px;margin-bottom:15px;">ğŸ“¤</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">Upload SQL Backup File</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:20px;">Select a .sql file to restore your database</p>
      
      <input type="file" name="backup_file" accept=".sql" required style="display:block;margin:0 auto 20px;padding:10px;border:1px solid #ddd;border-radius:5px;max-width:400px;width:100%;">
      
      <button type="submit" style="background:#e74c3c;color:#fff;border:none;padding:12px 30px;border-radius:6px;cursor:pointer;font-size:15px;font-weight:500;transition:all 0.3s;">
        â®ï¸ Restore Database
      </button>
    </div>
  </form>

  <div style="background:#f8d7da;border-left:4px solid #dc3545;padding:15px;border-radius:5px;margin-top:20px;">
    <strong style="color:#721c24;">ğŸš¨ Important Notes:</strong>
    <ul style="margin:10px 0 0 20px;color:#721c24;line-height:1.8;">
      <li>Only restore from trusted backup files</li>
      <li>Ensure the backup file is compatible with current database version</li>
      <li>The restore process may take several minutes</li>
      <li>All users will be logged out during restoration</li>
    </ul>
  </div>
</div>

<!-- Database Management -->
<div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin-bottom:30px;">
  <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>ğŸ”§</i> Database Maintenance</h3>
  <p style="color:#7f8c8d;margin-bottom:20px;">Optimize and maintain your database for better performance.</p>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">
    <!-- Optimize Database -->
    <div style="border:2px solid #9b59b6;border-radius:8px;padding:20px;text-align:center;">
      <div style="font-size:48px;margin-bottom:10px;">âš¡</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">Optimize Tables</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">Defragment and optimize all database tables</p>
      <form method="post" action="/database/optimize" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" style="background:#9b59b6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
          âš¡ Optimize Now
        </button>
      </form>
    </div>

    <!-- Check Database -->
    <div style="border:2px solid #1abc9c;border-radius:8px;padding:20px;text-align:center;">
      <div style="font-size:48px;margin-bottom:10px;">ğŸ”</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">Check Tables</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">Verify table integrity and check for errors</p>
      <form method="post" action="/database/check" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" style="background:#1abc9c;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
          ğŸ” Check Now
        </button>
      </form>
    </div>

    <!-- Repair Database -->
    <div style="border:2px solid #e74c3c;border-radius:8px;padding:20px;text-align:center;">
      <div style="font-size:48px;margin-bottom:10px;">ğŸ”¨</div>
      <h4 style="color:#2c3e50;margin-bottom:10px;">Repair Tables</h4>
      <p style="color:#7f8c8d;font-size:13px;margin-bottom:15px;">Repair corrupted or damaged tables</p>
      <form method="post" action="/database/repair" style="display:inline;" onsubmit="return confirm('Repair database tables? This may take several minutes.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" style="background:#e74c3c;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
          ğŸ”¨ Repair Now
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Backup History -->
{% if backup_history %}
<div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin-bottom:30px;">
  <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>ğŸ“œ</i> Recent Backup History</h3>
  
  <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#ecf0f1;border-bottom:2px solid #bdc3c7;">
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Date/Time</th>
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Type</th>
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Filename</th>
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Size</th>
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Created By</th>
          <th style="padding:12px;text-align:left;font-size:13px;color:#2c3e50;">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for backup in backup_history %}
        <tr style="border-bottom:1px solid #ecf0f1;">
          <td style="padding:12px;font-size:13px;color:#555;">{{ backup.created_at.strftime('%Y-%m-%d %H:%M') if backup.created_at else 'N/A' }}</td>
          <td style="padding:12px;font-size:13px;">
            <span style="background:#3498db;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">{{ backup.backup_type }}</span>
          </td>
          <td style="padding:12px;font-size:13px;color:#555;">{{ backup.filename }}</td>
          <td style="padding:12px;font-size:13px;color:#555;">{{ (backup.file_size / 1024 / 1024)|round(2) if backup.file_size else '0' }} MB</td>
          <td style="padding:12px;font-size:13px;color:#555;">{{ backup.created_by or 'System' }}</td>
          <td style="padding:12px;font-size:13px;">
            {% if backup.status == 'completed' %}
            <span style="color:#27ae60;">âœ“ {{ backup.status }}</span>
            {% else %}
            <span style="color:#e74c3c;">âœ— {{ backup.status }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Database Information & Settings -->
<div style="background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);">
  <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i>ğŸ“‹</i> Database Information</h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;">
    <div style="background:#ecf0f1;padding:15px;border-radius:6px;">
      <div style="font-size:12px;color:#7f8c8d;margin-bottom:5px;">Database Name</div>
      <div style="font-size:18px;font-weight:600;color:#2c3e50;">{{ db_info.name if db_info else 'db_asset' }}</div>
    </div>
    
    <div style="background:#ecf0f1;padding:15px;border-radius:6px;">
      <div style="font-size:12px;color:#7f8c8d;margin-bottom:5px;">Database Type</div>
      <div style="font-size:18px;font-weight:600;color:#2c3e50;">MySQL</div>
    </div>
    
    <div style="background:#ecf0f1;padding:15px;border-radius:6px;">
      <div style="font-size:12px;color:#7f8c8d;margin-bottom:5px;">Total Size</div>
      <div style="font-size:18px;font-weight:600;color:#2c3e50;">{{ db_info.size if db_info else 'N/A' }}</div>
    </div>

    <div style="background:#ecf0f1;padding:15px;border-radius:6px;">
      <div style="font-size:12px;color:#7f8c8d;margin-bottom:5px;">Total Tables</div>
      <div style="font-size:18px;font-weight:600;color:#2c3e50;">{{ db_info.tables if db_info else 'N/A' }}</div>
    </div>
  </div>

  <!-- Database Settings Form -->
  <form method="post" action="/database/settings" style="margin-top:20px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <h4 style="margin-bottom:15px;color:#2c3e50;">Backup Settings</h4>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
      <div>
        <label style="display:block;margin-bottom:5px;color:#555;font-size:14px;">
          <input type="checkbox" name="auto_backup_enabled" value="true" {% if settings and settings.auto_backup_enabled == 'true' %}checked{% endif %}>
          Enable Automatic Daily Backups
        </label>
      </div>

      <div>
        <label style="display:block;margin-bottom:5px;color:#555;font-size:14px;">Backup Time (24hr format)</label>
        <input type="time" name="auto_backup_time" value="{{ settings.auto_backup_time if settings else '02:00' }}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
      </div>

      <div>
        <label style="display:block;margin-bottom:5px;color:#555;font-size:14px;">Retention Period (days)</label>
        <input type="number" name="backup_retention_days" value="{{ settings.backup_retention_days if settings else '30' }}" min="1" max="365" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
      </div>

      <div>
        <label style="display:block;margin-bottom:5px;color:#555;font-size:14px;">
          <input type="checkbox" name="optimize_on_backup" value="true" {% if settings and settings.optimize_on_backup == 'true' %}checked{% endif %}>
          Optimize Tables During Backup
        </label>
      </div>
    </div>

    <div style="margin-top:20px;">
      <button type="submit" style="background:#3498db;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
        ğŸ’¾ Save Settings
      </button>
    </div>
  </form>

  <div style="margin-top:20px;padding:15px;background:#d1ecf1;border-left:4px solid #17a2b8;border-radius:5px;">
    <strong style="color:#0c5460;">â„¹ï¸ Backup Recommendations:</strong>
    <ul style="margin:10px 0 0 20px;color:#0c5460;line-height:1.8;">
      <li>Enable automatic backups for data protection</li>
      <li>Keep at least 7-30 days of backup history</li>
      <li>Store backups in a separate secure location</li>
      <li>Test restore procedures regularly</li>
      <li>Run optimize before important operations</li>
    </ul>
  </div>
</div>

{% endblock %}
